<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>B&K Finance Tracker</title>
<meta name="theme-color" content="#0c1222">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
:root {
  --bg: #0c1222;
  --card: #151d30;
  --card2: #1a2540;
  --border: #1e2d4a;
  --text: #e8edf5;
  --sub: #7e90b5;
  --dim: #4d6080;
  --blue: #4f8cff;
  --green: #34d399;
  --red: #f87171;
  --purple: #a78bfa;
  --r: 16px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-text-size-adjust:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100dvh;-webkit-font-smoothing:antialiased;overflow-x:hidden;
}
.hdr{
  position:sticky;top:0;z-index:100;
  background:rgba(12,18,34,.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);padding:14px 20px;
}
.hdr-inner{display:flex;justify-content:space-between;align-items:center;max-width:540px;margin:0 auto}
.hdr-title{font-size:1.1rem;font-weight:700}
.hdr-right{display:flex;gap:8px;align-items:center}
.btn-cur{
  background:var(--blue);color:#fff;border:none;padding:6px 14px;border-radius:8px;
  font-size:.75rem;font-weight:700;cursor:pointer;
}
.btn-cur.gbp{background:var(--purple)}
.btn-cur:active{transform:scale(.93)}
.btn-ref{background:var(--card2);border:1px solid var(--border);color:var(--sub);
  width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:1.1rem;border:none}
.btn-ref:active{opacity:.7}
@keyframes spin{to{transform:rotate(360deg)}}
.nav{max-width:540px;margin:0 auto;padding:10px 20px 4px}
.nav select{
  width:100%;padding:12px 40px 12px 16px;
  background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:12px;
  font-size:.95rem;font-weight:500;appearance:none;-webkit-appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Cpath fill='%237e90b5' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 14px center;
}
.main{max-width:540px;margin:0 auto;padding:0 20px 90px}
.pg{display:none}
.pg.on{display:block}
.hero{text-align:center;padding:24px 0 18px}
.hero-lbl{font-size:.7rem;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:4px}
.hero-amt{font-size:2.2rem;font-weight:800;letter-spacing:-1px}
.hero-amt.pos{color:var(--green)}.hero-amt.neg{color:var(--red)}
.hero-sub{font-size:.72rem;color:var(--dim);margin-top:5px}
.stats{display:flex;gap:8px;margin-bottom:14px}
.stat{flex:1;text-align:center;padding:12px 8px;border-radius:12px}
.stat.g{background:rgba(52,211,153,.08)}.stat.r{background:rgba(248,113,113,.08)}.stat.b{background:rgba(79,140,255,.08)}
.stat-lbl{font-size:.62rem;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.stat-val{font-size:1rem;font-weight:700}
.stat.g .stat-val{color:var(--green)}.stat.r .stat-val{color:var(--red)}.stat.b .stat-val{color:var(--blue)}
.ppl{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.pcard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px}
.pcard.wide{grid-column:1/-1;margin-bottom:6px}
.pcard h4{font-size:.82rem;font-weight:700;margin-bottom:8px}
.prow{display:flex;justify-content:space-between;font-size:.78rem;padding:4px 0;border-bottom:1px solid rgba(30,45,74,.5)}
.prow:last-child{border:none}
.prow span:first-child{color:var(--sub)}
.prow span:last-child{font-weight:600;font-variant-numeric:tabular-nums}
.pcard.wide .pgrid{display:grid;grid-template-columns:1fr 1fr;gap:0 16px}
.pnl{background:var(--card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:14px;overflow:hidden}
.pnl-hd{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border)}
.pnl-hd h3{font-size:.88rem;font-weight:600}
.pnl-bd{}
.btn-t{background:none;border:none;color:var(--blue);font-size:.78rem;font-weight:600;cursor:pointer}
.agrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding-top:8px}
@media(max-width:380px){.agrid{grid-template-columns:1fr}}
.acard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px}
.acard .icon{font-size:1.1rem;margin-bottom:4px}
.acard .name{font-size:.76rem;font-weight:600;line-height:1.3}
.acard .purpose{font-size:.64rem;color:var(--dim);margin:2px 0 8px}
.acard .bal{font-size:1.1rem;font-weight:700;font-variant-numeric:tabular-nums}
.acard .bal.pos{color:var(--green)}.acard .bal.neg{color:var(--red)}
.acard .native{font-size:.6rem;color:var(--dim);margin-top:2px}
.acard .chg{font-size:.64rem;margin-top:4px;font-weight:500}
.acard .chg.pos{color:var(--green)}.acard .chg.neg{color:var(--red)}
.sf-wrap{position:relative;margin:12px 18px 0}
.sf-btn{
  width:100%;display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;background:var(--card2);border:1px solid var(--border);border-radius:12px;
  color:var(--text);font-size:.86rem;font-weight:500;cursor:pointer;
}
.sf-btn:active{border-color:var(--blue)}
.sf-chev{color:var(--dim);transition:transform .2s}
.sf-btn.open .sf-chev{transform:rotate(180deg)}
.sf-panel{
  display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;z-index:300;
  background:var(--card2);border:1px solid var(--border);border-radius:14px;
  box-shadow:0 12px 40px rgba(0,0,0,.5);max-height:65vh;overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.sf-panel.open{display:block}
.sf-item{
  display:flex;align-items:center;gap:12px;padding:13px 18px;cursor:pointer;
  border-bottom:1px solid rgba(30,45,74,.4);user-select:none;-webkit-user-select:none;
}
.sf-item:last-child{border:none}
.sf-item:active{background:var(--card)}
.sf-item input{width:20px;height:20px;accent-color:var(--blue);cursor:pointer;flex-shrink:0}
.sf-info{flex:1;min-width:0}
.sf-name{font-size:.82rem;font-weight:500}
.sf-sub{font-size:.66rem;color:var(--dim);margin-top:1px}
.sf-badge{font-size:.6rem;font-weight:700;background:var(--border);color:var(--sub);padding:2px 7px;border-radius:5px}
.sf-actions{
  display:flex;align-items:center;justify-content:flex-end;gap:12px;
  padding:10px 18px;border-top:1px solid var(--border);background:var(--card);position:sticky;bottom:0;
}
.btn-f{background:var(--blue);color:#fff;border:none;padding:8px 20px;border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer}
.periods{display:flex;gap:6px;padding:12px 18px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border)}
.pbtn{
  padding:8px 14px;border-radius:8px;background:var(--bg);color:var(--sub);
  border:1px solid var(--border);font-size:.76rem;font-weight:600;cursor:pointer;
}
.pbtn.on{background:var(--blue);color:#fff;border-color:var(--blue)}
.pbtn:active{transform:scale(.95)}
.pmon{
  padding:8px 28px 8px 10px;background:var(--bg);color:var(--sub);
  border:1px solid var(--border);border-radius:8px;font-size:.76rem;font-weight:500;
  appearance:none;-webkit-appearance:none;cursor:pointer;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10'%3E%3Cpath fill='%237e90b5' d='M5 7L0 2h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 8px center;
}
.pmon.on{background:var(--blue);color:#fff;border-color:var(--blue);
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10'%3E%3Cpath fill='white' d='M5 7L0 2h10z'/%3E%3C/svg%3E")}
.ss{display:flex;gap:14px;padding:10px 18px;font-size:.76rem;color:var(--sub);border-bottom:1px solid var(--border)}
.ss b.pos{color:var(--green)}.ss b.neg{color:var(--red)}
.tx{display:flex;justify-content:space-between;align-items:flex-start;padding:13px 18px;gap:10px;border-bottom:1px solid rgba(30,45,74,.35)}
.tx:last-child{border:none}
.tx-l{flex:1;min-width:0}
.tx-d{font-size:.84rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-m{font-size:.66rem;color:var(--dim);margin-top:3px;line-height:1.35}
.tx-r{text-align:right;flex-shrink:0}
.tx-a{font-size:.88rem;font-weight:700;font-variant-numeric:tabular-nums}
.tx-a.pos{color:var(--green)}.tx-a.neg{color:var(--red)}
.tx-n{font-size:.58rem;color:var(--dim);margin-top:1px}
.tx-b{font-size:.58rem;color:var(--sub);margin-top:2px}
.goal{padding:14px 18px;border-bottom:1px solid rgba(30,45,74,.35)}
.goal:last-child{border:none}
.goal-top{display:flex;justify-content:space-between;margin-bottom:8px}
.goal-nm{font-size:.86rem;font-weight:600}
.goal-ds{font-size:.66rem;color:var(--dim);margin-top:2px}
.goal-pc{font-size:1rem;font-weight:800;color:var(--blue)}
.pbar{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-bottom:6px}
.pfill{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));border-radius:3px;transition:width .5s}
.goal-am{font-size:.72rem;color:var(--sub)}
.chart-w{padding:14px}
.chart-w canvas{width:100%!important;max-height:200px}
.empty{text-align:center;color:var(--dim);padding:32px 16px;font-size:.84rem}
.bst{font-size:.58rem;font-weight:700;margin-top:2px}
.bst.od{color:var(--red)}.bst.ds{color:#fbbf24}
.bkdp{display:none;position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.45)}
.bkdp.open{display:block}
.ftr{position:fixed;bottom:0;left:0;right:0;z-index:100;
  background:var(--card);border-top:1px solid var(--border);
  text-align:center;padding:10px 20px;font-size:.66rem;color:var(--dim)}
</style>
</head>
<body>

<header class="hdr"><div class="hdr-inner">
  <div class="hdr-title">üí∞ B&K Finances</div>
  <div class="hdr-right">
    <button class="btn-cur" id="curBtn">$ AUD</button>
    <button class="btn-ref" id="refBtn">üîÑ</button>
  </div>
</div></header>

<nav class="nav"><select id="nav">
  <option value="overview">üìä  Overview</option>
  <option value="accounts">üè¶  Accounts</option>
  <option value="statements">üìÑ  Statements</option>
  <option value="wages">üíµ  Wages</option>
  <option value="bills">üìã  Bills</option>
  <option value="savings">üíé  Savings</option>
  <option value="insights">üí°  Insights</option>
</select></nav>

<div class="main">
  <div id="overview" class="pg on">
    <div class="hero">
      <div class="hero-lbl">Total Balance</div>
      <div class="hero-amt" id="totalBal">$0.00</div>
      <div class="hero-sub">across all accounts</div>
    </div>
    <div class="stats">
      <div class="stat g"><div class="stat-lbl">Income</div><div class="stat-val" id="sInc">$0</div></div>
      <div class="stat r"><div class="stat-lbl">Expenses</div><div class="stat-val" id="sExp">$0</div></div>
      <div class="stat b"><div class="stat-lbl">Saved</div><div class="stat-val" id="sSav">--%</div></div>
    </div>
    <div class="ppl">
      <div class="pcard"><h4>üë§ Bailey</h4><div class="prow"><span>Wages</span><span id="bW">$0</span></div><div class="prow"><span>Spending</span><span id="bS">$0</span></div></div>
      <div class="pcard"><h4>üë§ Katie</h4><div class="prow"><span>Wages</span><span id="kW">$0</span></div><div class="prow"><span>Spending</span><span id="kS">$0</span></div></div>
    </div>
    <div class="pcard wide"><h4>ü§ù Joint</h4><div class="pgrid"><div class="prow"><span>Bills</span><span id="jB">$0</span></div><div class="prow"><span>Savings</span><span id="jSv">$0</span></div><div class="prow"><span>Food</span><span id="jF">$0</span></div><div class="prow"><span>Credit</span><span id="jC">$0</span></div></div></div>
    <div class="pnl"><div class="pnl-hd"><h3>Recent Transactions</h3><button class="btn-t" id="viewAll">View all</button></div><div class="pnl-bd" id="recTxns"><div class="empty">No transactions yet ‚Äî upload a statement to #finances</div></div></div>
  </div>

  <div id="accounts" class="pg">
    <div class="agrid" id="aCards"></div>
  </div>

  <div id="statements" class="pg">
    <div class="pnl">
      <div class="pnl-hd"><h3>Statements</h3></div>
      <div class="sf-wrap">
        <button class="sf-btn" id="sfBtn"><span id="sfLbl">üè¶ All Accounts</span><span class="sf-chev">‚ñæ</span></button>
        <div class="sf-panel" id="sfPanel">
          <div id="sfList"></div>
          <div class="sf-actions"><button class="btn-t" id="sfAll">Select all</button><button class="btn-t" id="sfNone">None</button><button class="btn-f" id="sfDone">Done</button></div>
        </div>
      </div>
      <div class="periods">
        <button class="pbtn on" data-d="7">7D</button>
        <button class="pbtn" data-d="30">30D</button>
        <button class="pbtn" data-d="90">90D</button>
        <select class="pmon" id="sMon"><option value="">Month‚Ä¶</option></select>
      </div>
      <div class="ss" id="stmtSum"></div>
      <div class="pnl-bd" id="stmtList"><div class="empty">No transactions yet</div></div>
    </div>
    <div class="pnl"><div class="pnl-hd"><h3>Balance Over Time</h3></div><div class="chart-w"><canvas id="balChart"></canvas></div></div>
  </div>

  <div id="wages" class="pg"><div class="pnl"><div class="pnl-hd"><h3>üíµ Wage History</h3></div><div class="pnl-bd" id="wContent"><div class="empty">No wage data yet</div></div></div></div>
  <div id="bills" class="pg"><div class="pnl"><div class="pnl-hd"><h3>üìã Recurring Bills</h3></div><div class="pnl-bd" id="biContent"><div class="empty">No bills detected yet</div></div></div></div>
  <div id="savings" class="pg"><div class="pnl"><div class="pnl-hd"><h3>üíé Savings Goals</h3></div><div class="pnl-bd" id="svContent"><div class="empty">No goals set up</div></div></div></div>
  <div id="insights" class="pg"><div class="pnl"><div class="pnl-hd"><h3>ü§ñ BAI Insights</h3></div><div class="pnl-bd"><div class="empty">Upload statements to #finances to get insights</div></div></div></div>
</div>

<footer class="ftr"><span id="fSrc">‚Äî</span> ¬∑ <span id="fRate">¬£1 = $‚Äî</span> ¬∑ BAI ü§ñ</footer>
<div class="bkdp" id="bkdp"></div>

<script>
/* ===== CONFIG (inline) ===== */
var CONFIG = {
  GAS_URL: 'https://script.google.com/macros/s/AKfycbyNhnB9By57QvqkRpcSelScDOH1gYeMRVWwgXIA6eLFTUvuWWUaZvg9mSMAuHf1sAPh1Q/exec',
  ACCOUNTS: [
    { id:'bw_cba', name:'BW Personal (Commonwealth)', bank:'CBA', user:'Bailey', purpose:'Wages', currency:'AUD', icon:'üèõÔ∏è', type:'checking' },
    { id:'katie_cba', name:'Katie Personal (Commonwealth)', bank:'CBA', user:'Katie', purpose:'Wages', currency:'AUD', icon:'üèõÔ∏è', type:'checking' },
    { id:'joint_cba', name:'Joint (Commonwealth)', bank:'CBA', user:'Joint', purpose:'Bills', currency:'AUD', icon:'üèõÔ∏è', type:'checking' },
    { id:'saver_cba', name:'Joint Saver (Commonwealth)', bank:'CBA', user:'Joint', purpose:'Savings', currency:'AUD', icon:'üèõÔ∏è', type:'savings' },
    { id:'bw_starling', name:'BW Personal (Starling)', bank:'Starling', user:'Bailey', purpose:'Spending', currency:'GBP', icon:'‚≠ê', type:'checking' },
    { id:'katie_starling', name:'Katie Personal (Starling)', bank:'Starling', user:'Katie', purpose:'Spending', currency:'GBP', icon:'‚≠ê', type:'checking' },
    { id:'joint_starling', name:'Joint (Starling)', bank:'Starling', user:'Joint', purpose:'Food', currency:'GBP', icon:'‚≠ê', type:'checking' },
    { id:'cc_capone', name:'Credit Card (Capital One)', bank:'Capital One', user:'Joint', purpose:'Credit', currency:'GBP', icon:'üí≥', type:'credit' }
  ]
};

/* ===== DATA MANAGER (inline) ===== */
var DM = {
  cache: {},
  exchangeRate: { gbpToAud: 1.95, audToGbp: 0.513 },
  displayCurrency: 'AUD',
  dataSource: 'loading',

  async fetchAll() {
    try {
      var resp = await fetch(CONFIG.GAS_URL + '?action=all');
      var raw = await resp.json();
      if (raw.error) throw new Error(raw.error);
      this.cache = raw;
      this.dataSource = 'live';
      if (raw.exchangeRate) this.exchangeRate = raw.exchangeRate;
      return true;
    } catch (e) {
      console.error('Fetch failed:', e);
      this.dataSource = 'error';
      if (!this.cache.accounts) {
        this.cache = {
          accounts: CONFIG.ACCOUNTS.map(function(a){return{'Account Name':a.name,'Type':a.type,'Bank':a.bank,'User':a.user,'Purpose':a.purpose,'Current Balance':0,'Previous Balance':0,'Currency':a.currency}}),
          ledger:[],wages:[],bills:[],savings:[],history:[],dashboard:[]
        };
      }
      return false;
    }
  },

  async fetchLedger(month, accounts) {
    try {
      var params = '?action=ledger_all';
      if (month) params += '&month=' + month;
      if (accounts && accounts.length) params += '&accounts=' + encodeURIComponent(accounts.join(','));
      var resp = await fetch(CONFIG.GAS_URL + params);
      var raw = await resp.json();
      return raw.data || [];
    } catch (e) { return []; }
  },

  convert: function(amount, from, to) {
    if (!to) to = this.displayCurrency;
    if (from === to) return amount;
    if (from === 'GBP' && to === 'AUD') return amount * (this.exchangeRate.gbpToAud || 1.95);
    if (from === 'AUD' && to === 'GBP') return amount * (this.exchangeRate.audToGbp || 0.513);
    return amount;
  },

  fmt: function(amount, currency) {
    if (!currency) currency = this.displayCurrency;
    var sym = currency === 'GBP' ? '¬£' : '$';
    var abs = Math.abs(amount);
    var s = sym + abs.toLocaleString('en-AU', {minimumFractionDigits:2, maximumFractionDigits:2});
    return amount < 0 ? '-' + s : s;
  },

  getCurrency: function(name) {
    if (!name) return 'AUD';
    var c = CONFIG.ACCOUNTS.find(function(a){return a.name === name});
    return c ? c.currency : 'AUD';
  },

  getAccounts: function() {
    return (this.cache.accounts || []).map(function(a){
      var cur = DM.getCurrency(a['Account Name']);
      var bal = parseFloat(a['Current Balance']) || 0;
      var prev = parseFloat(a['Previous Balance']) || 0;
      return {
        name: a['Account Name'], type: a['Type'], bank: a['Bank'],
        user: a['User'], purpose: a['Purpose'],
        nativeBalance: bal, nativeCurrency: cur,
        balance: DM.convert(bal, cur),
        change: DM.convert(bal - prev, cur)
      };
    });
  },

  getLedger: function() {
    return (this.cache.ledger || []).map(function(e){
      var cur = e['Currency'] || DM.getCurrency(e['Account']);
      return {
        date: e['Date'] ? new Date(e['Date']) : null,
        description: e['Description'] || '',
        amount: parseFloat(e['Amount']) || 0,
        balanceAfter: parseFloat(e['Balance After']) || 0,
        category: e['Category'] || '',
        account: e['Account'] || '',
        currency: cur,
        convertedAmount: DM.convert(parseFloat(e['Amount']) || 0, cur),
        convertedBalance: DM.convert(parseFloat(e['Balance After']) || 0, cur)
      };
    }).sort(function(a,b){return (b.date||0) - (a.date||0)});
  },

  getDashboardMetric: function(name) {
    var d = this.cache.dashboard || [];
    var m = d.find(function(x){return x['Metric'] === name});
    return m ? (parseFloat(m['Value']) || 0) : 0;
  }
};

/* ===== APP (inline) ===== */
(function(){
  'use strict';
  var sa = CONFIG.ACCOUNTS.map(function(a){return a.name}), sDays=7, sMonth='', sfOpen=false, tab='overview';

  document.addEventListener('DOMContentLoaded', async function(){
    wireNav(); wireCur(); wireRef();
    document.getElementById('viewAll').onclick = function(){go('statements')};
    buildFilter(); wirePeriods(); wireMonth();
    await DM.fetchAll();
    renderAll();
  });

  function renderAll(){
    try { renderOverview(); } catch(e){ console.error('Overview error:', e); }
    try { renderAccts(); } catch(e){ console.error('Accounts error:', e); }
    try { popMonths(); } catch(e){ console.error('Months error:', e); }
    try { renderFtr(); } catch(e){ console.error('Footer error:', e); }
  }

  function wireNav(){
    var n = document.getElementById('nav');
    n.addEventListener('change', function(e){go(e.target.value)});
    var h = location.hash.slice(1);
    if (h && document.getElementById(h)){n.value = h; go(h)}
  }
  function go(t){
    tab = t;
    document.querySelectorAll('.pg').forEach(function(p){p.classList.remove('on')});
    var el = document.getElementById(t);
    if (el) el.classList.add('on');
    document.getElementById('nav').value = t;
    history.replaceState(null, '', '#' + t);
    if (t === 'statements') renderStmt();
    if (t === 'wages') renderWages();
    if (t === 'bills') renderBills();
    if (t === 'savings') renderSavings();
  }

  function wireCur(){
    document.getElementById('curBtn').addEventListener('click', function(){
      DM.displayCurrency = DM.displayCurrency === 'AUD' ? 'GBP' : 'AUD';
      this.textContent = DM.displayCurrency === 'AUD' ? '$ AUD' : '¬£ GBP';
      this.classList.toggle('gbp', DM.displayCurrency === 'GBP');
      renderAll(); if (tab === 'statements') renderStmt();
    });
  }

  function wireRef(){
    var b = document.getElementById('refBtn');
    b.addEventListener('click', async function(){
      b.style.animation = 'spin .8s linear infinite';
      await DM.fetchAll(); renderAll();
      if (tab === 'statements') renderStmt();
      b.style.animation = 'none';
    });
  }

  function buildFilter(){
    var list = document.getElementById('sfList');
    list.innerHTML = CONFIG.ACCOUNTS.map(function(a){
      return '<label class="sf-item"><input type="checkbox" value="'+a.name+'" checked>'+
        '<div class="sf-info"><div class="sf-name">'+a.icon+' '+a.name+'</div>'+
        '<div class="sf-sub">'+a.user+' ¬∑ '+a.purpose+'</div></div>'+
        '<span class="sf-badge">'+a.currency+'</span></label>';
    }).join('');
    var btn=document.getElementById('sfBtn'), panel=document.getElementById('sfPanel'), bk=document.getElementById('bkdp');
    btn.addEventListener('click', function(e){e.stopPropagation();sfOpen=!sfOpen;panel.classList.toggle('open',sfOpen);btn.classList.toggle('open',sfOpen);bk.classList.toggle('open',sfOpen)});
    bk.addEventListener('click', closeF);
    list.addEventListener('change', syncF);
    document.getElementById('sfAll').addEventListener('click', function(){list.querySelectorAll('input').forEach(function(c){c.checked=true});syncF()});
    document.getElementById('sfNone').addEventListener('click', function(){list.querySelectorAll('input').forEach(function(c){c.checked=false});syncF()});
    document.getElementById('sfDone').addEventListener('click', function(){closeF();renderStmt()});
  }
  function closeF(){sfOpen=false;document.getElementById('sfPanel').classList.remove('open');document.getElementById('sfBtn').classList.remove('open');document.getElementById('bkdp').classList.remove('open')}
  function syncF(){
    var ch = document.querySelectorAll('#sfList input:checked');
    sa = [].slice.call(ch).map(function(c){return c.value});
    var n = sa.length, t = CONFIG.ACCOUNTS.length;
    document.getElementById('sfLbl').textContent = n===t ? 'üè¶ All Accounts' : n===0 ? 'üè¶ None' : 'üè¶ '+n+' Account'+(n>1?'s':'');
  }

  function wirePeriods(){
    document.querySelectorAll('.pbtn').forEach(function(b){
      b.addEventListener('click', function(){
        document.querySelectorAll('.pbtn').forEach(function(x){x.classList.remove('on')});
        b.classList.add('on');
        document.getElementById('sMon').value=''; document.getElementById('sMon').classList.remove('on');
        sDays = parseInt(b.dataset.d); sMonth=''; renderStmt();
      });
    });
  }
  function wireMonth(){
    document.getElementById('sMon').addEventListener('change', function(e){
      if (e.target.value){
        document.querySelectorAll('.pbtn').forEach(function(x){x.classList.remove('on')});
        e.target.classList.add('on'); sMonth=e.target.value; sDays=0;
      } else {
        e.target.classList.remove('on');
        document.querySelector('.pbtn[data-d="7"]').classList.add('on');
        sMonth=''; sDays=7;
      }
      renderStmt();
    });
  }
  function popMonths(){
    var ldg = DM.getLedger(), ms = {};
    ldg.forEach(function(e){if(e.date){var k=e.date.getFullYear()+'-'+String(e.date.getMonth()+1).padStart(2,'0');ms[k]=true}});
    var sel = document.getElementById('sMon');
    while(sel.options.length > 1) sel.remove(1);
    Object.keys(ms).sort().reverse().forEach(function(m){
      var o = document.createElement('option'); o.value = m;
      var p = m.split('-'); o.textContent = new Date(p[0],p[1]-1).toLocaleString('en-AU',{month:'short',year:'numeric'});
      sel.appendChild(o);
    });
  }

  function renderOverview(){
    var a = DM.getAccounts(), l = DM.getLedger();
    var tot = a.reduce(function(s,x){return s+x.balance}, 0);
    var h = document.getElementById('totalBal');
    h.textContent = DM.fmt(tot); h.className = 'hero-amt ' + (tot >= 0 ? 'pos' : 'neg');

    // Use dashboard metrics if ledger is empty
    var inc, exp, savRate;
    if (l.length > 0) {
      inc = l.filter(function(t){return t.amount>0}).reduce(function(s,t){return s+t.convertedAmount},0);
      exp = Math.abs(l.filter(function(t){return t.amount<0}).reduce(function(s,t){return s+t.convertedAmount},0));
      savRate = inc > 0 ? ((inc-exp)/inc*100).toFixed(0) : '--';
    } else {
      inc = DM.getDashboardMetric('Monthly Income');
      exp = DM.getDashboardMetric('Monthly Expenses');
      savRate = DM.getDashboardMetric('Savings Rate');
      if (savRate > 0 && savRate < 1) savRate = (savRate * 100).toFixed(0);
      else if (savRate === 0 && inc > 0) savRate = ((inc-exp)/inc*100).toFixed(0);
      else savRate = '--';
    }

    document.getElementById('sInc').textContent = DM.fmt(inc);
    document.getElementById('sExp').textContent = DM.fmt(exp);
    document.getElementById('sSav').textContent = savRate + '%';

    var b = function(n){var x=a.find(function(x){return x.name===n});return DM.fmt(x?x.balance:0)};
    document.getElementById('bW').textContent = b('BW Personal (Commonwealth)');
    document.getElementById('bS').textContent = b('BW Personal (Starling)');
    document.getElementById('kW').textContent = b('Katie Personal (Commonwealth)');
    document.getElementById('kS').textContent = b('Katie Personal (Starling)');
    document.getElementById('jB').textContent = b('Joint (Commonwealth)');
    document.getElementById('jSv').textContent = b('Joint Saver (Commonwealth)');
    document.getElementById('jF').textContent = b('Joint (Starling)');
    document.getElementById('jC').textContent = b('Credit Card (Capital One)');

    var el = document.getElementById('recTxns');
    el.innerHTML = l.length ? l.slice(0,20).map(function(t){return tx(t)}).join('') : '<div class="empty">No transactions yet ‚Äî upload a statement to #finances</div>';
  }

  function renderAccts(){
    var a = DM.getAccounts(), g = document.getElementById('aCards');
    g.innerHTML = a.map(function(x){
      var c = CONFIG.ACCOUNTS.find(function(c){return c.name===x.name}) || {};
      var nv = x.nativeCurrency !== DM.displayCurrency ? '<div class="native">'+DM.fmt(x.nativeBalance,x.nativeCurrency)+' '+x.nativeCurrency+'</div>' : '';
      return '<div class="acard"><div class="icon">'+(c.icon||'üí∞')+'</div><div class="name">'+x.name.replace(/ \(.*\)/,'')+'</div>'+
        '<div class="purpose">'+x.purpose+' ¬∑ '+x.nativeCurrency+'</div>'+
        '<div class="bal '+(x.balance>=0?'pos':'neg')+'">'+DM.fmt(x.balance)+'</div>'+nv+
        '<div class="chg '+(x.change>=0?'pos':'neg')+'">'+(x.change>=0?'‚Üó':'‚Üò')+' '+DM.fmt(Math.abs(x.change))+'</div></div>';
    }).join('');
  }

  async function renderStmt(){
    var el=document.getElementById('stmtList'), sm=document.getElementById('stmtSum');
    el.innerHTML='<div class="empty">Loading‚Ä¶</div>';
    var data;
    try {
      if(sMonth){
        var raw = await DM.fetchLedger(sMonth, sa.length<8?sa:null);
        data = raw.map(function(e){return trRow(e)}).filter(function(t){return sa.indexOf(t.account)>=0}).sort(function(a,b){return(b.date||0)-(a.date||0)});
      } else if(sDays>7){
        var raw = await DM.fetchLedger(null, sa.length<8?sa:null);
        var cut = new Date(); cut.setDate(cut.getDate()-sDays); cut.setHours(0,0,0,0);
        data = raw.map(function(e){return trRow(e)}).filter(function(t){return t.date&&t.date>=cut&&sa.indexOf(t.account)>=0}).sort(function(a,b){return(b.date||0)-(a.date||0)});
      } else {
        data = DM.getLedger().filter(function(t){return sa.indexOf(t.account)>=0});
      }
    } catch(e) { data = []; }
    var tIn = data.filter(function(t){return t.amount>0}).reduce(function(s,t){return s+t.convertedAmount},0);
    var tOut = Math.abs(data.filter(function(t){return t.amount<0}).reduce(function(s,t){return s+t.convertedAmount},0));
    sm.innerHTML = 'In: <b class="pos">'+DM.fmt(tIn)+'</b> &nbsp; Out: <b class="neg">'+DM.fmt(tOut)+'</b> &nbsp; '+data.length+' txns';
    el.innerHTML = data.length ? data.map(function(t){return tx(t,true)}).join('') : '<div class="empty">No transactions found</div>';
    renderChart(data);
  }

  function trRow(e){
    var c = e['Currency'] || DM.getCurrency(e['Account']);
    return {date:e['Date']?new Date(e['Date']):null, description:e['Description']||'', amount:parseFloat(e['Amount'])||0,
      balanceAfter:parseFloat(e['Balance After'])||0, category:e['Category']||'', account:e['Account']||'', currency:c,
      convertedAmount:DM.convert(parseFloat(e['Amount'])||0,c), convertedBalance:DM.convert(parseFloat(e['Balance After'])||0,c)};
  }

  function renderChart(data){
    var cv = document.getElementById('balChart');
    if (!cv || !window.Chart) return;
    var s = data.slice().sort(function(a,b){return(a.date||0)-(b.date||0)});
    if (!s.length) return;
    if (cv._c) cv._c.destroy();
    cv._c = new Chart(cv, {type:'line', data:{
      labels:s.map(function(e){return e.date?e.date.toLocaleDateString('en-AU',{day:'numeric',month:'short'}):''}),
      datasets:[{data:s.map(function(e){return e.convertedBalance}),borderColor:'#4f8cff',backgroundColor:'rgba(79,140,255,.06)',
        fill:true,tension:.35,pointRadius:0,borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
        scales:{x:{ticks:{maxTicksLimit:6,color:'#4d6080',font:{size:9}},grid:{display:false}},
          y:{ticks:{color:'#4d6080',font:{size:9},callback:function(v){return DM.fmt(v)}},grid:{color:'rgba(30,45,74,.4)'}}}}
    });
  }

  function renderWages(){
    var w = DM.cache.wages||[], el = document.getElementById('wContent');
    if (!w.length){el.innerHTML='<div class="empty">No wage data yet</div>';return}
    el.innerHTML = w.map(function(e){var c=e['Currency']||'AUD',a=parseFloat(e['Amount'])||0,cv=DM.convert(a,c);
      var n=c!==DM.displayCurrency?'<div class="tx-n">'+DM.fmt(a,c)+' '+c+'</div>':'';
      return '<div class="tx"><div class="tx-l"><div class="tx-d">'+(e['User']||'')+'</div><div class="tx-m">'+fd(e['Date'])+' ¬∑ '+(e['Day of Week']||'')+' ¬∑ '+(e['Account']||'')+'</div></div><div class="tx-r"><div class="tx-a pos">'+DM.fmt(cv)+'</div>'+n+'</div></div>'}).join('');
  }
  function renderBills(){
    var b = DM.cache.bills||[], el = document.getElementById('biContent');
    if (!b.length){el.innerHTML='<div class="empty">No bills detected yet</div>';return}
    el.innerHTML = b.map(function(e){var c=e['Currency']||'AUD',a=Math.abs(parseFloat(e['Amount']))||0,st=e['Status']||'Active',sc=st==='Overdue'?'od':st==='Due Soon'?'ds':'';
      return '<div class="tx"><div class="tx-l"><div class="tx-d">'+(e['Bill Name']||'')+'</div><div class="tx-m">'+(e['Frequency']||'Monthly')+' ¬∑ Next: '+fd(e['Next Due Date'])+'</div></div><div class="tx-r"><div class="tx-a neg">'+DM.fmt(DM.convert(a,c))+'</div><div class="bst '+sc+'">'+st+'</div></div></div>'}).join('');
  }
  function renderSavings(){
    var g = DM.cache.savings||[], el = document.getElementById('svContent');
    if (!g.length){el.innerHTML='<div class="empty">No goals set up</div>';return}
    el.innerHTML = g.map(function(e){var tg=parseFloat(e['Target Amount'])||1,cu=parseFloat(e['Current Amount'])||0,pc=Math.min(100,cu/tg*100).toFixed(1);
      return '<div class="goal"><div class="goal-top"><div><div class="goal-nm">'+(e['Goal Name']||'')+'</div><div class="goal-ds">'+(e['Description']||'')+'</div></div><div class="goal-pc">'+pc+'%</div></div><div class="pbar"><div class="pfill" style="width:'+pc+'%"></div></div><div class="goal-am">'+DM.fmt(cu)+' / '+DM.fmt(tg)+'</div></div>'}).join('');
  }

  function tx(t, sb){
    var p = t.amount>0, a = DM.fmt(t.convertedAmount);
    var n = t.currency!==DM.displayCurrency ? '<div class="tx-n">'+DM.fmt(t.amount,t.currency)+' '+t.currency+'</div>' : '';
    var bl = sb ? '<div class="tx-b">Bal: '+DM.fmt(t.convertedBalance)+'</div>' : '';
    return '<div class="tx"><div class="tx-l"><div class="tx-d">'+t.description+'</div><div class="tx-m">'+fd(t.date)+' ¬∑ '+(t.account||'').replace(/ \(.*\)/,'')+' ¬∑ '+t.category+'</div></div><div class="tx-r"><div class="tx-a '+(p?'pos':'neg')+'">'+(p?'+':'')+a+'</div>'+n+bl+'</div></div>';
  }
  function fd(d){if(!d)return'';var dt=new Date(d);return isNaN(dt)?'':dt.toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'2-digit'})}
  function renderFtr(){
    document.getElementById('fSrc').textContent = DM.dataSource==='live' ? 'üü¢ Live' : DM.dataSource==='error' ? 'üî¥ Offline' : 'üü° Demo';
    document.getElementById('fRate').textContent = '¬£1 = $'+(DM.exchangeRate.gbpToAud||1.95).toFixed(2);
  }
})();
</script>
</body>
</html>
